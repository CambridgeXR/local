<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>360 VR Player (Cambridge XR)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<meta name="theme-color" content="#000000"/>
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
<style>
html,body {margin:0;padding:0;height:100%;background:#000;color:#fff;font-family:sans-serif;overflow:hidden;}
canvas {display:block;width:100vw;height:100vh;}
#ui {position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;pointer-events:none;opacity:1;transition:opacity .4s ease;}
#ui.fade {opacity:0;}
.btn {pointer-events:auto;appearance:none;border:none;padding:14px 16px;border-radius:12px;font-weight:600;font-size:1.05rem;background:#1a73e8;color:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(26,115,232,.35);}
.btn.secondary {background:#2b2b2b;}
input[type=file]{display:none;}
.footer {position:fixed;bottom:8px;left:50%;transform:translateX(-50%);font-size:.8rem;font-style:italic;color:#aaa;}
</style>
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('sw.js').catch(console.error);
  });
}
</script>
</head>
<body>
<canvas id="glcanvas"></canvas>
<video id="video360" playsinline webkit-playsinline preload="metadata" loop crossorigin="anonymous" style="display:none"></video>
<div id="ui">
  <button id="selectBtn" class="btn secondary">Select simulation</button>
  <input id="fileInput" type="file" accept="video/*" />
  <button id="vrBtn" class="btn" disabled>Enter VR</button>
</div>
<div class="footer">Brought to you by Cambridge XR</div>
<script>
// ===== UI handling =====
const ui=document.getElementById('ui'),fileInput=document.getElementById('fileInput'),
selectBtn=document.getElementById('selectBtn'),vrBtn=document.getElementById('vrBtn'),
video=document.getElementById('video360'); 
let hideUITimer=null,cardboard=false,objectURL=null;
function scheduleUIHide(){
  clearTimeout(hideUITimer);
  hideUITimer=setTimeout(()=>{ui.classList.add('fade');},4000);
}
function showUI(){
  clearTimeout(hideUITimer);
  ui.classList.remove('fade');
  scheduleUIHide();
}
selectBtn.onclick=()=>fileInput.click();
fileInput.onchange=async e=>{
  const file=e.target.files?.[0];
  if(!file)return;
  if(objectURL)URL.revokeObjectURL(objectURL);
  objectURL=URL.createObjectURL(file);
  video.src=objectURL;
  await video.play().catch(()=>{});
  vrBtn.disabled=false;
  showUI();
};
addEventListener('pointerdown',()=>{
  if(cardboard){recenterView();}
  else{showUI();}
},{passive:true});
// ===== Device orientation via quaternion =====
let refQuat=null,currentQuat=[0,0,0,1],smoothedQuat=[0,0,0,1];
function toRad(d){return d*Math.PI/180;}
function quatFromEuler(alpha,beta,gamma){
  const _x=toRad(beta),_y=toRad(gamma),_z=toRad(alpha);
  const cX=Math.cos(_x/2),cY=Math.cos(_y/2),cZ=Math.cos(_z/2),
        sX=Math.sin(_x/2),sY=Math.sin(_y/2),sZ=Math.sin(_z/2);
  const w=cX*cY*cZ - sX*sY*sZ,
        x=sX*cY*cZ - cX*sY*sZ,
        y=cX*sY*cZ + sX*cY*sZ,
        z=cX*cY*sZ + sX*sY*cZ;
  return [x,y,z,w];
}
function quatMultiply(a,b){
  return [
    a[3]*b[0]+a[0]*b[3]+a[1]*b[2]-a[2]*b[1],
    a[3]*b[1]-a[0]*b[2]+a[1]*b[3]+a[2]*b[0],
    a[3]*b[2]+a[0]*b[1]-a[1]*b[0]+a[2]*b[3],
    a[3]*b[3]-a[0]*b[0]-a[1]*b[1]-a[2]*b[2]
  ];
}
function quatInverse(q){
  const n=q[0]*q[0]+q[1]*q[1]+q[2]*q[2]+q[3]*q[3];
  return [-q[0]/n,-q[1]/n,-q[2]/n,q[3]/n];
}
function recenterView(){refQuat=quatInverse(smoothedQuat);}
addEventListener('deviceorientation',e=>{
  if(e.alpha==null)return;
  const q=quatFromEuler(e.alpha,e.beta,e.gamma);
  const target=refQuat?quatMultiply(refQuat,q):q;
  // smoothing
  const s=0.15;
  for(let i=0;i<4;i++)smoothedQuat[i]=smoothedQuat[i]*(1-s)+target[i]*s;
},true);
// ===== WebGL sphere rendering =====
const canvas=document.getElementById('glcanvas');
let gl=canvas.getContext('webgl')||canvas.getContext('experimental-webgl');
function resize(){canvas.width=innerWidth*devicePixelRatio;canvas.height=innerHeight*devicePixelRatio;gl.viewport(0,0,canvas.width,canvas.height);}
addEventListener('resize',resize);resize();
// sphere geometry
function createSphere(uSeg=64,vSeg=64){
  const verts=[],uvs=[],idx=[];
  for(let y=0;y<=vSeg;y++){
    const v=y/vSeg,phi=v*Math.PI;
    for(let x=0;x<=uSeg;x++){
      const u=x/uSeg,theta=u*Math.PI*2;
      const sx=Math.sin(phi)*Math.cos(theta),sy=Math.cos(phi),sz=Math.sin(phi)*Math.sin(theta);
      verts.push(sx,sy,sz);uvs.push(u,1-v);
    }
  }
  for(let y=0;y<vSeg;y++){
    for(let x=0;x<uSeg;x++){
      const i=y*(uSeg+1)+x;
      idx.push(i,i+uSeg+1,i+1,i+1,i+uSeg+1,i+uSeg+2);
    }
  }
  return {verts:new Float32Array(verts),uvs:new Float32Array(uvs),idx:new Uint16Array(idx)};
}
const sphere=createSphere();
function compileShader(src,type){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);if(!gl.getShaderParameter(s,gl.COMPILE_STATUS))throw gl.getShaderInfoLog(s);return s;}
const vs=compileShader(`attribute vec3 p;attribute vec2 t;varying vec2 v;uniform mat4 mvp;void main(){v=t;gl_Position=mvp*vec4(-p.x,p.y,p.z,1.0);}`,gl.VERTEX_SHADER);
const fs=compileShader(`precision mediump float;varying vec2 v;uniform sampler2D tex;void main(){gl_FragColor=texture2D(tex,v);}`,gl.FRAGMENT_SHADER);
const prog=gl.createProgram();gl.attachShader(prog,vs);gl.attachShader(prog,fs);gl.linkProgram(prog);
gl.useProgram(prog);
const pLoc=gl.getAttribLocation(prog,'p'),tLoc=gl.getAttribLocation(prog,'t'),
mvpLoc=gl.getUniformLocation(prog,'mvp'),texLoc=gl.getUniformLocation(prog,'tex');
function bufData(target,data,loc,size){const b=gl.createBuffer();gl.bindBuffer(target,b);gl.bufferData(target,data,gl.STATIC_DRAW);if(loc!==null){gl.enableVertexAttribArray(loc);gl.vertexAttribPointer(loc,size,gl.FLOAT,false,0,0);}return b;}
bufData(gl.ARRAY_BUFFER,sphere.verts,pLoc,3);
bufData(gl.ARRAY_BUFFER,sphere.uvs,tLoc,2);
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,bufData(gl.ELEMENT_ARRAY_BUFFER,sphere.idx,null,null));
const tex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,tex);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
function updateTex(){if(video.readyState>=2){gl.bindTexture(gl.TEXTURE_2D,tex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,video);}}
function perspective(out,fov,aspect,near,far){const f=1.0/Math.tan(fov/2),nf=1/(near-far);out[0]=f/aspect;out[1]=0;out[2]=0;out[3]=0;out[4]=0;out[5]=f;out[6]=0;out[7]=0;out[8]=0;out[9]=0;out[10]=(far+near)*nf;out[11]=-1;out[12]=0;out[13]=0;out[14]=2*far*near*nf;out[15]=0;}
function quatToMat4(q){const [x,y,z,w]=q;const x2=x+x,y2=y+y,z2=z+z;const xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;return new Float32Array([1-(yy+zz),xy+wz,xz-wy,0,xy-wz,1-(xx+zz),yz+wx,0,xz+wy,yz-wx,1-(xx+yy),0,0,0,0,1]);}
function multiplyMat4(a,b){const out=new Float32Array(16);for(let i=0;i<4;i++){for(let j=0;j<4;j++){out[i*4+j]=a[i*4+0]*b[0*4+j]+a[i*4+1]*b[1*4+j]+a[i*4+2]*b[2*4+j]+a[i*4+3]*b[3*4+j];}}return out;}
function render(){resize();updateTex();gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT);
const aspect=canvas.width/canvas.height;const proj=new Float32Array(16);
if(cardboard){
  const halfW=canvas.width/2;const aspectEye=halfW/canvas.height;perspective(proj,Math.PI/2,aspectEye,0.1,100);
  const view=quatToMat4(smoothedQuat);
  gl.viewport(0,0,halfW,canvas.height);gl.uniformMatrix4fv(mvpLoc,false,multiplyMat4(proj,view));gl.drawElements(gl.TRIANGLES,sphere.idx.length,gl.UNSIGNED_SHORT,0);
  gl.viewport(halfW,0,halfW,canvas.height);gl.uniformMatrix4fv(mvpLoc,false,multiplyMat4(proj,view));gl.drawElements(gl.TRIANGLES,sphere.idx.length,gl.UNSIGNED_SHORT,0);
} else {
  perspective(proj,Math.PI/2,aspect,0.1,100);const view=quatToMat4(smoothedQuat);
  gl.viewport(0,0,canvas.width,canvas.height);gl.uniformMatrix4fv(mvpLoc,false,multiplyMat4(proj,view));gl.drawElements(gl.TRIANGLES,sphere.idx.length,gl.UNSIGNED_SHORT,0);
}
requestAnimationFrame(render);}
render();
// ===== VR button =====
vrBtn.onclick=async()=>{
  if(typeof DeviceOrientationEvent!=="undefined" && typeof DeviceOrientationEvent.requestPermission==="function"){
    const resp=await DeviceOrientationEvent.requestPermission();if(resp!=="granted")return;
  }
  cardboard=true;
  try{await screen.orientation.lock('landscape');}catch(e){}
  recenterView();
  showUI();
};
scheduleUIHide();
</script>
</body>
</html>
